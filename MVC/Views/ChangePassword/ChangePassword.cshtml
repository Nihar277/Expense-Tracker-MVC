@model MVC.Models.vm_ChangePassword
@{
    ViewData["Title"] = "Change Password";
    Layout = "../Shared/_UserLayout.cshtml";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
/* Card styling */
.change-password-card {
    background-color: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    padding: 40px 30px;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    max-width: 450px;
    width: 100%;
}

/* Input focus effect for Change Password form */
.change-password-card input[type="text"],
.change-password-card input[type="email"],
.change-password-card input[type="password"] {
    transition: all 0.3s ease;
    outline: none;
}

.change-password-card input:focus {
    border-color: #2ECC71; /* Green border on focus */
    box-shadow: 0 0 8px rgba(46, 204, 113, 0.4); /* Soft glow */
    background-color: rgba(255, 255, 255, 0.8);
}


/* Error container at top */
#formErrors {
    margin-bottom: 20px;
    color: #e74c3c;
    font-weight: 500;
}

/* Form styling */
.form-group {
    margin-bottom: 25px;
}
.form-group label {
    font-weight: 600;
    color: #333;
    margin-bottom: 6px;
    display: block;
}

/* Input + eye container */
.input-wrapper {
    position: relative;
    width: 100%;
}
.input-wrapper input {
    width: 100%;
    padding: 10px 40px 10px 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
    outline: none;
    font-size: 14px;
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(5px);
    box-sizing: border-box;
}
.input-wrapper .password-toggle-icon {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    color: #666;
    font-size: 16px;
}

/* Password strength */
.strength-bar-container {
    width: 100%;
    height: 6px;
    background-color: #ddd;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 8px;
    margin-bottom: 8px;
}
.strength-bar {
    height: 6px;
    width: 0;
    background-color: transparent;
    border-radius: 3px;
    transition: width 0.3s ease, background-color 0.3s ease;
}
.strength-requirements {
    list-style: none;
    padding: 0;
    margin: 0;
    font-size: 13px;
}
.strength-requirements li {
    display: flex;
    align-items: center;
    margin-bottom: 4px;
    color: #888;
}
.strength-requirements li.valid {
    color: #4CAF50;
}
.strength-requirements li i {
    margin-right: 6px;
}

/* Button */
#changePassword {
    width: 100%;
    padding: 12px;
    background-color: #2ECC71;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
}
</style>

<div class="d-flex flex-column align-items-center mt-5">
    <div class="change-password-card">

        <div class="card-header d-flex align-items-center mb-3" style="border-radius: 8px; background-color: #f8f8f8;">
            <div class="me-3 p-3 text-white rounded-circle m-4" style="background-color: #2ECC71;">
                <i class="fas fa-lock m-2"></i>
            </div>
            <div>
                <h4 class="mb-0">Change Password</h4>
                <small class="text-muted">Update your account password</small>
            </div>
        </div>

        <!-- Error container -->
        <div id="formErrors"></div>

        <form id="passwordForm">
            <div class="form-group">
                <label>Current Password</label>
                <div class="input-wrapper">
                    <input type="password" id="currentPassword" placeholder="Enter current password" />
                    <i class="fas fa-eye password-toggle-icon"></i>
                </div>
            </div>

            <div class="form-group">
                <label>New Password</label>
                <div class="input-wrapper">
                    <input type="password" id="newPassword" placeholder="Enter new password" />
                    <i class="fas fa-eye password-toggle-icon"></i>
                </div>
                <div class="strength-bar-container">
                    <div class="strength-bar" id="strengthbar"></div>
                </div>
                <ul class="strength-requirements">
                    <li id="req-uppercase"><i class="fas fa-times-circle"></i> At least 1 uppercase.</li>
                    <li id="req-number"><i class="fas fa-times-circle"></i> At least 1 number.</li>
                    <li id="req-length"><i class="fas fa-times-circle"></i> At least 6 characters.</li>
                </ul>
            </div>

            <div class="form-group">
                <label>Confirm Password</label>
                <div class="input-wrapper">
                    <input type="password" id="confirmPassword" placeholder="Enter confirm password" />
                    <i class="fas fa-eye password-toggle-icon"></i>
                </div>
            </div>

            <button id="changePassword" type="button">Change Password</button>
        </form>
    </div>
</div>

@section Scripts {
<script>
$(document).ready(function(){

    // Password toggle
    $(".password-toggle-icon").on("click", function () {
        const input = $(this).siblings("input");
        const type = input.attr("type") === "password" ? "text" : "password";
        input.attr("type", type);
        $(this).toggleClass("fa-eye fa-eye-slash");
    });

    // Password strength
    $("#newPassword").on("input", function () {
        const val = $(this).val();
        let strength = 0;
        const hasUpper = /[A-Z]/.test(val);
        const hasNum = /[0-9]/.test(val);
        const hasLen = val.length >= 6;
        toggleRequirement("#req-uppercase", hasUpper);
        toggleRequirement("#req-number", hasNum);
        toggleRequirement("#req-length", hasLen);
        strength = hasUpper + hasNum + hasLen;
        const bar = $("#strengthbar");
        bar.css("width", (strength / 3 * 100) + "%");
        if(strength === 0) bar.css("background-color","transparent");
        else if(strength === 1) bar.css("background-color","#e74c3c");
        else if(strength === 2) bar.css("background-color","#f59e0b");
        else bar.css("background-color","#4CAF50");
    });

    function toggleRequirement(selector, valid){
        const el = $(selector);
        el.toggleClass("valid", valid);
        el.find("i").toggleClass("fa-check-circle", valid);
        el.find("i").toggleClass("fa-times-circle", !valid);
    }

    // Validation function
    function validateForm() {
        let errors = [];
        const current = $("#currentPassword").val().trim();
        const newP = $("#newPassword").val().trim();
        const confirm = $("#confirmPassword").val().trim();

        if(!current) errors.push("Current password is required.");
        if(!newP) errors.push("New password is required.");
        if(!confirm) errors.push("Confirm password is required.");
        if(newP && confirm && newP !== confirm) errors.push("New password and confirm password do not match.");

        return errors;
    }

    function showFormErrors(errors) {
        if(errors.length > 0){
            const html = errors.map(e => `<div>${e}</div>`).join('');
            $("#formErrors").html(html);
            return true;
        } else {
            $("#formErrors").html('');
            return false;
        }
    }

    // Submit
    $("#changePassword").click(function(){
        const errors = validateForm();
        if(showFormErrors(errors)) return;

        const data = {
            CurrentPassword: $("#currentPassword").val().trim(),
            NewPassword: $("#newPassword").val().trim(),
            ConfirmPassword: $("#confirmPassword").val().trim()
        };

        $.ajax({
            url:'/ChangePassword',
            type:'POST',
            contentType:'application/json',
            data: JSON.stringify(data),
            success: function(res){
                setTimeout(() => {
                    if(res.success){
                        window.location.href = '/User/UserGraph';
                    }
                }, 1000);
                Swal.fire({
                    toast: true,
                    icon: res.success ? 'success' : 'error',
                    title: res.message,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
            },
            error: function(){
                Swal.fire({
                    toast: true,
                    icon: 'error',
                    title: 'Something went wrong. Try again later.',
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
            }
        });
    });

});
</script>
}
